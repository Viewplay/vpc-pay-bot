<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VPC Payment</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#111;color:#fff;display:flex;justify-content:center;padding:20px;}
.container{width:100%;max-width:420px;background:#1a1a1a;padding:20px;border-radius:12px;}
h1{color:red;text-align:center}
label{display:block;margin-top:15px;font-weight:bold}
input{width:100%;padding:12px;margin-top:5px;border:none;border-radius:8px;background:#333;color:#fff;font-size:16px;}
.button{margin-top:20px;background:red;color:#fff;padding:15px;border:none;width:100%;border-radius:8px;font-size:18px;}
.summary{background:#222;margin-top:30px;padding:20px;border-radius:12px;text-align:center;}
.qr-code{display:flex;justify-content:center;margin:25px 0;}
.qr-code img{background:#fff;padding:12px;border-radius:12px;}
.copy-btn,.back-btn{background:red;color:white;padding:10px;margin:10px 0;border:none;border-radius:8px;width:100%;}
#cryptoAddress{word-break:break-word}
.addr-block{margin-top:14px;}
.dd{position:relative;margin-top:5px}
.dd-btn{width:100%;padding:12px;border-radius:8px;background:#333;color:#fff;border:none;display:flex;align-items:center;justify-content:space-between;cursor:pointer;}
.dd-left{display:flex;align-items:center;gap:10px}
.dd-left img{width:22px}
.dd-list{position:absolute;left:0;right:0;top:110%;background:#222;border-radius:10px;display:none;z-index:20;}
.dd-item{padding:12px;display:flex;align-items:center;gap:10px;cursor:pointer;}
.dd-item:hover{background:#333}
.dd-item img{width:22px}
.error{color:#ff3b3b;font-size:13px;margin-top:6px;font-weight:bold;display:none;}
button{font-weight:bold;}
.btn-row{display:flex;justify-content:space-between;gap:10px;margin-top:20px;}
.back-white{background:#fff !important;color:#000 !important;margin:0 !important;}
.paid-btn{background:red;color:#fff;padding:10px;margin:0;border:none;border-radius:8px;width:100%;}
</style>
</head>
<body>
<div class="container">
<h1>Buy VPC</h1>

<div id="formSection">
  <label>Amount</label>
  <input id="usd" type="number" placeholder="$ USD"/>
  <div id="usdError" class="error"></div>

  <label>Pay with</label>
  <div class="dd" id="dd">
    <button class="dd-btn" id="ddBtn" type="button">
      <span class="dd-left">
        <img id="ddIcon" src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" alt="BTC">
        <span id="ddText">BTC</span>
      </span>
      <span>▾</span>
    </button>
    <div class="dd-list" id="ddList"></div>
  </div>
  <input type="hidden" id="crypto" value="bitcoin">

  <label>Your Solana address</label>
  <input id="wallet" type="text" placeholder="Enter Solana wallet"/>
  <div id="walletError" class="error"></div>

  <label>Promo code (optional)</label>
  <input id="promo" type="text" placeholder=""/>
  <div id="promoError" class="error"></div>

  <button class="button" onclick="generatePayment()">Generate Payment</button>
</div>

<div id="summary" class="summary" style="display:none">
  <p id="usdAmount"></p>
  <p id="discount"></p>
  <p id="vpc"></p>
  <p id="cryptoPrice"></p>
  <p id="amountToPay"></p>

  <p class="addr-block"><strong>Crypto Address:</strong><br><span id="cryptoAddress"></span></p>
  <button class="copy-btn" onclick="copyText('cryptoAddress')">Copy address</button>

  <p><strong>Amount:</strong><br><span id="cryptoAmount"></span></p>
  <button class="copy-btn" onclick="copyText('cryptoAmount')">Copy amount</button>

  <div class="qr-code">
    <img id="qrCode" width="140" height="140" alt="QR Code"/>
  </div>

  <div class="btn-row">
    <button class="back-btn back-white" onclick="goBack()">Return</button>
    <button class="paid-btn" onclick="iHavePaid()">I have paid</button>
  </div>
</div>

</div>

<script>
/** SET THIS TO YOUR RENDER BACKEND URL */
const API_BASE = "https://vpc-bot.onrender.com";

/* Dropdown */
const METHODS=[
  {value:"bitcoin",label:"BTC",icon:"https://cryptologos.cc/logos/bitcoin-btc-logo.png"},
  {value:"ethereum",label:"ETH",icon:"https://cryptologos.cc/logos/ethereum-eth-logo.png"},
  {value:"solana",label:"SOL",icon:"https://cryptologos.cc/logos/solana-sol-logo.png"},
  {value:"usdt_trc20",label:"USDT (TRC20)",icon:"https://cryptologos.cc/logos/tether-usdt-logo.png"},
  {value:"usdt_erc20",label:"USDT (ERC20)",icon:"https://cryptologos.cc/logos/tether-usdt-logo.png"},
  {value:"usdt_sol",label:"USDT (SOL)",icon:"https://cryptologos.cc/logos/tether-usdt-logo.png"},
];
const ddList=document.getElementById("ddList");
const ddBtn=document.getElementById("ddBtn");
const ddIcon=document.getElementById("ddIcon");
const ddText=document.getElementById("ddText");
const cryptoHidden=document.getElementById("crypto");

METHODS.forEach(m=>{
  const d=document.createElement("div");
  d.className="dd-item";
  d.innerHTML=`<img src="${m.icon}" alt="${m.label}"><span>${m.label}</span>`;
  d.onclick=()=>{
    cryptoHidden.value=m.value;
    ddIcon.src=m.icon;
    ddIcon.alt=m.label;
    ddText.textContent=m.label;
    ddList.style.display="none";
  };
  ddList.appendChild(d);
});
ddBtn.onclick=()=>ddList.style.display=ddList.style.display==="block"?"none":"block";
document.addEventListener("click",e=>{
  if(!document.getElementById("dd").contains(e.target)) ddList.style.display="none";
});

/* Validation */
const usdEl = document.getElementById("usd");
const walletEl = document.getElementById("wallet");
const promoEl = document.getElementById("promo");

const usdError = document.getElementById("usdError");
const walletError = document.getElementById("walletError");
const promoError = document.getElementById("promoError");

function showError(el, msg){ el.textContent = msg; el.style.display="block"; }
function clearError(el){ el.textContent=""; el.style.display="none"; }
usdEl.addEventListener("input", ()=> clearError(usdError));
walletEl.addEventListener("input", ()=> clearError(walletError));
promoEl.addEventListener("input", ()=> clearError(promoError));

const BASE58_ALPHABET="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
const BASE58_MAP=(()=>{const m={};for(let i=0;i<BASE58_ALPHABET.length;i++) m[BASE58_ALPHABET[i]]=i;return m;})();

function base58Decode(str){
  if(typeof str!=="string"||str.length===0) return null;
  for(let i=0;i<str.length;i++) if(BASE58_MAP[str[i]]===undefined) return null;
  let bytes=[0];
  for(let i=0;i<str.length;i++){
    const val=BASE58_MAP[str[i]];
    let carry=val;
    for(let j=0;j<bytes.length;j++){
      const x=bytes[j]*58+carry;
      bytes[j]=x&0xff;
      carry=x>>8;
    }
    while(carry>0){ bytes.push(carry&0xff); carry>>=8; }
  }
  let leadingZeros=0;
  for(let i=0;i<str.length && str[i]==="1"; i++) leadingZeros++;
  for(let i=0;i<leadingZeros;i++) bytes.push(0);
  bytes.reverse();
  return new Uint8Array(bytes);
}
function isValidSolanaAddress(addr){
  if(typeof addr!=="string") return false;
  const a=addr.trim();
  if(a.length<32||a.length>44) return false;
  const decoded=base58Decode(a);
  return decoded && decoded.length===32;
}

/* Bot integration */
let currentOrderId=null;
let pollTimer=null;

async function api(path, options){
  const r = await fetch(`${API_BASE}${path}`, {
    ...options,
    headers: { "Content-Type":"application/json", ...(options?.headers||{}) }
  });
  const data = await r.json().catch(()=> ({}));
  if(!r.ok){
    const msg = (data && (data.error||data.message)) ? (data.error||data.message) : `HTTP ${r.status}`;
    throw new Error(msg);
  }
  return data;
}

function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer=null; }
function startPolling(){
  stopPolling();
  pollTimer=setInterval(async ()=>{
    if(!currentOrderId) return;
    try{
      const o=await api(`/api/order/${currentOrderId}`,{method:"GET"});
      if(o.status==="FULFILLED"){
        stopPolling();
        document.getElementById("cryptoPrice").innerHTML =
          `<strong>Status:</strong> ✅ Confirmed & VPC sent<br><small>${o.fulfillTxSignature||""}</small>`;
      }else if(o.status==="PAID"){
        document.getElementById("cryptoPrice").innerHTML =
          `<strong>Status:</strong> Payment confirmed… sending VPC`;
      }else if(o.status==="EXPIRED"){
        stopPolling();
        document.getElementById("cryptoPrice").innerHTML =
          `<strong>Status:</strong> ❌ Expired. Please generate again.`;
      }else if(o.status==="FAILED"){
        stopPolling();
        document.getElementById("cryptoPrice").innerHTML =
          `<strong>Status:</strong> ❌ Failed. Contact support.`;
      }else{
        document.getElementById("cryptoPrice").innerHTML =
          `<strong>Status:</strong> Waiting for payment confirmation…`;
      }
    }catch(_e){}
  }, 5000);
}

async function generatePayment(){
  const usd=parseFloat(usdEl.value);
  if(usdEl.value.trim()===""){ showError(usdError,"Please enter an amount."); return; }
  if(isNaN(usd) || usd<20){ showError(usdError,"Minimum amount is $20."); return; }

  const solAddr=walletEl.value.trim();
  if(!isValidSolanaAddress(solAddr)){ showError(walletError,"Invalid Solana address."); return; }

  const promoCode=promoEl.value.trim();
  const payMethod=cryptoHidden.value;

  try{
    const order=await api("/api/order",{
      method:"POST",
      body: JSON.stringify({ usd, solanaAddress: solAddr, payMethod, promoCode })
    });
    currentOrderId=order.orderId;

    document.getElementById('usdAmount').innerHTML = `<strong>USD:</strong> $${Number(order.usd).toFixed(2)}`;
    document.getElementById('discount').innerHTML = `<strong>Discount:</strong> ${(Number(order.discountRate)*100).toFixed(1)}%`;
    document.getElementById('vpc').innerHTML = `<strong>VPC You Will Receive:</strong> ${Number(order.vpcAmount).toLocaleString()} VPC`;
    document.getElementById('amountToPay').innerHTML =
      `<strong>Amount to Pay:</strong> ${order.expectedCryptoAmount} ${order.currencyLabel}`;

    document.getElementById('cryptoAddress').textContent = order.depositAddress;
    document.getElementById('cryptoAmount').textContent = `${order.expectedCryptoAmount} ${order.currencyLabel}`;

    document.getElementById('qrCode').src =
      `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(`${order.payMethod}:${order.depositAddress}?amount=${order.expectedCryptoAmount}`)}`;

    formSection.style.display="none";
    summary.style.display="block";
    startPolling();
  }catch(e){
    showError(usdError, e.message || "Server error");
  }
}

function goBack(){
  stopPolling();
  currentOrderId=null;
  summary.style.display="none";
  formSection.style.display="block";
}

async function iHavePaid(){
  if(!currentOrderId){ alert("No active order."); return; }
  try{
    await api(`/api/order/${currentOrderId}/paid`,{method:"POST",body:JSON.stringify({})});
    alert("OK. We are checking your payment on-chain.");
  }catch(e){
    alert(e.message || "Error");
  }
}

function copyText(id){
  navigator.clipboard.writeText(document.getElementById(id).textContent);
}
</script>
</body>
</html>
